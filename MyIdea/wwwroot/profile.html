<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyIdea - Profile</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles_feed.css">
    <link rel="stylesheet" href="animations.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h1>MyIdea</h1>
            </div>
            <div class="nav-links">
                <a href="feed.html" class="nav-link">
                    <i class="fas fa-home"></i> Feed
                </a>
                <div class="nav-search">
                    <input id="searchInput" type="search" placeholder="Search users..." aria-label="Search users">
                    <button id="searchBtn" class="btn-search"><i class="fas fa-search"></i></button>
                </div>
                <a href="profile.html" class="nav-link active">
                    <i class="fas fa-user"></i> Profile
                </a>
                <button id="themeToggle" class="theme-toggle">
                    <i class="fas fa-moon theme-icon"></i>
                </button>
                <button id="logoutBtn" class="logout-btn">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <!-- Profile Header -->
            <div class="profile-header">
                <div class="profile-cover">
                    <div class="profile-avatar-container">
                        <div id="profileAvatarContainer">
                            <img id="profileAvatar" src="" alt="Profile Avatar" class="profile-avatar">
                        </div>
                        <button id="triggerEditAvatar" class="edit-avatar-btn">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                </div>
                <div class="profile-info">
                    <h1 id="profileName">User Name</h1>
                    <p id="profileBio">No bio yet</p>
                    <div class="profile-stats">
                        <div class="stat">
                            <span class="stat-number" id="profilePosts">0</span>
                            <span class="stat-label">Posts</span>
                        </div>
                        <div class="stat">
                            <span class="stat-number" id="profileFollowers">0</span>
                            <span class="stat-label">Followers</span>
                        </div>
                        <div class="stat">
                            <span class="stat-number" id="profileFollowing">0</span>
                            <span class="stat-label">Following</span>
                        </div>
                    </div>
                    <div class="profile-actions">
                        <button id="editProfileBtn" class="btn-primary">
                            <i class="fas fa-edit"></i> Edit Profile
                        </button>
                        <div id="profileFollowContainer" style="display:inline-block; margin-left:8px"></div>
                        <button id="settingsBtn" class="btn-secondary">
                            <i class="fas fa-cog"></i> Settings
                        </button>
                    </div>
                </div>
            </div>

            <!-- Profile Content -->
            <div class="profile-content">
                <div class="content-tabs">
                    <button class="tab-btn active" data-tab="posts">Posts</button>
                    <button class="tab-btn" data-tab="liked">Liked</button>
                    <button class="tab-btn" data-tab="saved">Saved</button>
                </div>

                <div id="postsTab" class="tab-content active">
                    <div id="userPosts" class="posts-grid">
                        <!-- User posts will be loaded here -->
                    </div>
                </div>

                <div id="likedTab" class="tab-content">
                    <div id="likedPosts" class="posts-grid">
                        <!-- Liked posts will be loaded here -->
                    </div>
                </div>

                <div id="savedTab" class="tab-content">
                    <div id="savedPosts" class="posts-grid">
                        <!-- Saved posts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Profile</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="form-group">
                        <label for="editName">Full Name</label>
                        <input type="text" id="editName" required>
                    </div>
                    <div class="form-group">
                        <label for="editBio">Bio</label>
                        <textarea id="editBio" rows="3" placeholder="Tell us about yourself..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editAvatar">Profile Picture (image, GIF or short video â‰¤ 3s)</label>
                        <input type="file" id="editAvatar" accept="image/*,video/*">
                        <div id="avatarPreview" class="image-preview" style="display: none;"></div>
                    </div>
                    <button type="submit" class="btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h4>Privacy</h4>
                    <label class="setting-item">
                        <input type="checkbox" id="privateAccount">
                        Private Account
                    </label>
                    <label class="setting-item">
                        <input type="checkbox" id="showOnlineStatus">
                        Show Online Status
                    </label>
                </div>
                <div class="settings-section">
                    <h4>Notifications</h4>
                    <label class="setting-item">
                        <input type="checkbox" id="emailNotifications" checked>
                        Email Notifications
                    </label>
                    <label class="setting-item">
                        <input type="checkbox" id="pushNotifications" checked>
                        Push Notifications
                    </label>
                </div>
                <div class="settings-section">
                    <h4>Theme</h4>
                    <select id="themeSelect">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="auto">Auto</option>
                    </select>
                </div>
                <button id="saveSettings" class="btn-primary">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Page Transition -->
    <div class="page-transition" style="display: none;"></div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="pageLoading" style="display: none;">
        <div class="spinner"></div>
        <p>Loading profile...</p>
    </div>

    <!-- Load utilities first -->
    <script src="js/security.js"></script>
    <script src="js/validation.js"></script>
    
    <!-- Load services -->
    <script src="js/auth.js"></script>
    <script src="js/posts.js"></script>
    
    <!-- Load UI helpers -->
    <script src="js/ui.js"></script>
    <!-- Load feed controller so we can reuse post rendering and handlers -->
    <script src="js/feed.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Validate session
            if (!SecurityUtils.validateSession()) {
                window.location.href = 'login.html';
                return;
            }

            // Implement CSP
            const meta = document.createElement('meta');
            meta.httpEquiv = "Content-Security-Policy";
            meta.content = SecurityUtils.getCSPHeaders()['Content-Security-Policy'];
            document.head.appendChild(meta);

            // Setup form validation
            ValidationUtils.setupLiveValidation('editProfileForm', {
                editName: { required: true, minLength: 2, maxLength: 50 },
                editBio: { maxLength: 500 },
                editAvatar: { 
                    required: false,
                    fileType: ['image/*', 'video/*'],
                    maxSize: 5 * 1024 * 1024 // 5MB
                }
            });

            // Initialize services
            const auth = window.authService;
            const posts = window.postService;
            const ui = window.uiService;

            // Determine whose profile to show (self or ?userId=...)
            const params = new URLSearchParams(window.location.search);
            const viewUserId = params.get('userId');
            const currentUser = auth.getCurrentUser();

            let profileUser = null;
            if (viewUserId && viewUserId !== currentUser?.id) {
                // find the requested user
                profileUser = auth.users.find(u => u.id === viewUserId);
            }
            if (!profileUser) profileUser = currentUser;

            if (!profileUser) {
                window.location.href = 'login.html';
                return;
            }

            // Load profile UI
            document.getElementById('profileName').textContent = profileUser.name;
            document.getElementById('profileBio').textContent = profileUser.bio || 'No bio yet';
            const avatarEl = document.getElementById('profileAvatar');
            if (avatarEl) avatarEl.src = profileUser.avatar || '';

            // Load stats
            const userPosts = posts.getUserPosts(profileUser.id);
            document.getElementById('profilePosts').textContent = userPosts.length;
            document.getElementById('profileFollowers').textContent = profileUser.followers?.length || 0;
            document.getElementById('profileFollowing').textContent = profileUser.following?.length || 0;

            // Show/hide edit & settings based on ownership
            const isOwn = currentUser && currentUser.id === profileUser.id;
            document.getElementById('editProfileBtn').style.display = isOwn ? 'inline-flex' : 'none';
            document.getElementById('settingsBtn').style.display = isOwn ? 'inline-flex' : 'none';

            // Follow/unfollow button for other users
            const followContainer = document.getElementById('profileFollowContainer');
            if (!isOwn && followContainer) {
                followContainer.innerHTML = '';
                const btn = document.createElement('button');
                btn.className = 'btn-primary';
                const isFollowing = auth.isFollowing(profileUser.id);
                btn.textContent = isFollowing ? 'Unfollow' : 'Follow';
                btn.addEventListener('click', () => {
                    if (auth.isFollowing(profileUser.id)) {
                        auth.unfollow(profileUser.id);
                        btn.textContent = 'Follow';
                        ui.showNotification(`Unfollowed ${profileUser.name}`, 'info');
                    } else {
                        auth.follow(profileUser.id);
                        btn.textContent = 'Unfollow';
                        ui.showNotification(`Now following ${profileUser.name}`, 'success');
                    }
                    // Update follower counts
                    document.getElementById('profileFollowers').textContent = profileUser.followers?.length || 0;
                    document.getElementById('profileFollowing').textContent = profileUser.following?.length || 0;
                });
                followContainer.appendChild(btn);
            }

            // Load user posts into Posts tab
            const postsContainer = document.getElementById('userPosts');
            if (postsContainer) postsContainer.innerHTML = userPosts.map(post => window.feed.createPostElement(post)).join('');

            // Populate Liked tab (posts the profileUser liked)
            const likedContainer = document.getElementById('likedPosts');
            if (likedContainer) {
                const allPosts = posts.getPosts();
                const liked = allPosts.filter(p => Array.isArray(p.likes) && p.likes.includes(profileUser.id));
                likedContainer.innerHTML = liked.length ? liked.map(p => window.feed.createPostElement(p)).join('') : '<div style="color:var(--text-muted); padding:10px">No liked posts</div>';
            }

            // Saved tab (if user has saved posts)
            const savedContainer = document.getElementById('savedPosts');
            if (savedContainer) {
                const savedIds = profileUser.savedPosts || [];
                const all = posts.getPosts();
                const saved = all.filter(p => savedIds.includes(p.id));
                savedContainer.innerHTML = saved.length ? saved.map(p => window.feed.createPostElement(p)).join('') : '<div style="color:var(--text-muted); padding:10px">No saved posts</div>';
            }

            // Wire edit and settings buttons
            document.getElementById('editProfileBtn')?.addEventListener('click', () => { ui.openEditProfileModal(); });
            document.getElementById('settingsBtn')?.addEventListener('click', () => { ui.openSettingsModal(); });
            document.getElementById('saveSettings')?.addEventListener('click', () => { ui.saveSettings(); });

            // Edit Profile submission
            const editProfileForm = document.getElementById('editProfileForm');
            editProfileForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('editName').value.trim();
                const bio = document.getElementById('editBio').value.trim();
                const avatarInput = document.getElementById('editAvatar');
                const file = avatarInput?.files?.[0];
                try {
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(evt) {
                            const dataUrl = evt.target.result;
                            const success = auth.updateProfile({ name, bio, avatar: dataUrl });
                            if (success) { ui.showNotification('Profile updated successfully!', 'success'); location.reload(); }
                            else ui.showNotification('Failed to update profile', 'error');
                        };
                        reader.onerror = function() { ui.showNotification('Failed to read avatar file', 'error'); };
                        reader.readAsDataURL(file);
                    } else {
                        const success = auth.updateProfile({ name, bio });
                        if (success) { ui.showNotification('Profile updated successfully!', 'success'); location.reload(); }
                        else ui.showNotification('Failed to update profile', 'error');
                    }
                } catch (err) { ui.showNotification('Failed to update profile', 'error'); }
            });

            // Edit Profile handling (submit already provided below), prefill fields when modal opens
            // Validation + submit logic: reuse existing form handler added earlier

            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    const tabId = btn.dataset.tab;
                    document.getElementById(`${tabId}Tab`)?.classList.add('active');
                });
            });

            // Logout
            document.getElementById('logoutBtn')?.addEventListener('click', () => {
                auth.logout();
                window.location.href = 'login.html';
            });

            // Theme toggle
            document.getElementById('themeToggle')?.addEventListener('click', () => {
                const currentTheme = document.body.classList.contains('dark-theme') ? 'light' : 'dark';
                ui.setTheme(currentTheme);
            });

            // Simple search behavior: navigate to first matching user profile
            document.getElementById('searchBtn')?.addEventListener('click', () => {
                const q = (document.getElementById('searchInput')?.value || '').trim();
                if (!q) return;
                const results = auth.searchUsers(q);
                if (results && results.length) {
                    window.location.href = `profile.html?userId=${encodeURIComponent(results[0].id)}`;
                } else {
                    ui.showNotification('No users found', 'info');
                }
            });
        });
    </script>
</body>
</html>
